<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI — Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#f5f7fb; }

    /* ---------- Theme variables (overridable by URL or Sheet) ---------- */
    :root{
      /* Chat sizing */
      --chat-w: clamp(320px, 28vw, 420px);
      --chat-h: min(72vh, calc(var(--vh-px) - 96px));
      --pad-right: max(1rem, env(safe-area-inset-right));
      --pad-bottom: max(1rem, env(safe-area-inset-bottom));
      --vh-px: 100vh;

      /* Accent colors (default): user bubbles + buttons */
      --accent-bg: #2563eb;  /* background */
      --accent-fg: #ffffff;  /* text */
    }

    /* Framed site fills viewport */
    .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background: transparent; }

    /* Small status badge */
    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem;
      background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px;
      font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    /* Chat container */
    .chat { position: fixed; right: var(--pad-right); bottom: var(--pad-bottom); width: var(--chat-w); z-index: 50; color: #0b0b0c; }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem; overflow: hidden;
      display:flex; flex-direction:column;
      max-height: var(--chat-h);
    }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid rgba(0,0,0,.06); }
    .header-image { display:flex; align-items:center; gap:.75rem; }
    .header-image img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .header-image .title { font-size: 12px; font-weight: 600; }

    /* Messages area */
    .body { flex:1; min-height:0; overflow:auto; padding: .75rem; font-size: 14px; background: transparent; }
    .chat-bubble { max-width: 85%; margin:.45rem 0; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; line-height:1.35; }
    .chat-bubble p { margin:0; }
    .ai-bubble  { background:#f2f2f3; color:#0b0b0c; align-self:flex-start; }
    .user-bubble{ background: var(--accent-bg); color: var(--accent-fg); align-self:flex-end; }
    #chat-body { display:flex; flex-direction:column; }

    /* Composer: single line input */
    .composer {
      display:flex; align-items:center; gap:.5rem;
      padding:.5rem; border-top:1px solid #ececec; background: rgba(255,255,255,0.80);
    }
    .composer input{
      flex:1;
      border:1px solid #d1d5db; border-radius:.7rem;
      padding:.58rem .75rem;
      font-size:14px; line-height:1.35;
      background:#fff; height:40px;
    }
    .composer button{
      border:0; background: var(--accent-bg); color: var(--accent-fg);
      border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer;
    }

    /* CTA follows theme */
    .cta-wrap a{
      display:inline-block; text-decoration:none;
      background: var(--accent-bg);
      color: var(--accent-fg);
      border-radius:.7rem; padding:.6rem .9rem; margin: 5px;
      font-weight:600; font-size:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .cta-wrap a:hover { filter:brightness(0.95); }

    /* Launcher (minimised) */
    .launcher {
      position: fixed; right: 1rem; bottom: 1rem; z-index: 80; border: 0; background: var(--accent-bg); color: var(--accent-fg);
      border-radius: 999px; padding: .55rem .8rem; display: none; align-items: center; gap:.5rem; cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .launcher-icon { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    .launcher span { font-size: 14px; font-weight: 700; }

    /* Responsive via visual viewport */
    @media (max-width: 1024px){
      :root{ --chat-w: min(40vw, 420px); --chat-h: min(68vh, calc(var(--vh-px) - 88px)); }
    }
    @media (max-width: 768px){
      :root{ --chat-w: min(96vw, 460px); --chat-h: min(64vh, calc(var(--vh-px) - 80px)); }
    }
    @media (max-width: 480px){
      :root{ --chat-w: 100vw; --chat-h: calc(var(--vh-px) - 72px); }
      .chat { left:0; right:0; bottom:0; }
      .chat-card { border-radius:1rem 1rem 0 0; }
    }
  </style>
</head>
<body>

  <!-- Status badge -->
  <div id="badge" class="badge hidden"></div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat.png" alt="Jemima">
          <div class="title">Jemima <br/>Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer" aria-label="Minimise chat"><b>X</b></button>
      </div>

      <div class="body" id="chat-body" aria-live="polite">
        <div class="chat-bubble ai-bubble"><p>Hi, I am Jemima. I can answer thousands of Dental and Service questions.</p></div>
      </div>

      <div id="chat-quick-links" style="display:flex; gap:.5rem; padding:0 .75rem .75rem;"></div>

      <!-- Single line composer -->
      <form class="composer" id="form">
        <label for="chat-input" class="visually-hidden" style="position:absolute;left:-9999px;">Message</label>
        <input id="chat-input" type="text" placeholder="Ask Jemima" autocomplete="off" autocapitalize="sentences" spellcheck="true" />
        <button type="submit" id="sendBtn" aria-label="Send">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Launcher -->
  <button id="launcher" class="launcher" aria-label="Open chat">
    <img src="https://jemima.ai/jemima-chat.png" alt="Jemima" class="launcher-icon" />
    <span>Chat</span>
  </button>

  <script>
    /* -------- Overlay shell + path-based config via Google Sheet -------- */

    const PROXY_ORIGIN   = "";     // set if you deploy a proxy worker
    const LOAD_TIMEOUT_MS= 5000;

    // 1) PASTE your published gviz JSON URL here:
    // Example: https://docs.google.com/spreadsheets/d/<<SHEET_ID>>/gviz/tq?tqx=out:json&sheet=Config
    const SHEET_GVIZ_URL = "https://docs.google.com/spreadsheets/d/1bok0FcKAOPVR9eFPss55ebWAsQ_IdB0ypQ_9G8sRrGk/gviz/tq?tqx=out:json&sheet=Config";

    const $ = id => document.getElementById(id);
    const frame    = $('frame');
    const badge    = $('badge');
    const chat     = $('chat');
    const launcher = $('launcher');
    const ctaWrap  = $('ctaWrap');
    const cta      = $('cta');

    const state = { vertical: 'default', targetUrl: '', mode: 'auto', booking: '', color: '' };
    let overrides = null; // values sourced from sheet (path-based)

    /* Utility: get host slug from path: /dental-chat/<host> */
    function getHostFromPath(){
      const m = location.pathname.match(/\/dental-chat\/([^\/?#]+)/i);
      if (!m) return '';
      let host = decodeURIComponent(m[1] || '').trim();
      host = host.replace(/^https?:\/\//i,'').replace(/\/+$/,'').toLowerCase();
      host = host.replace(/^www\./,''); // normalize
      return host;
    }

    function normaliseTarget(input) {
      if (!input) return '';
      if (/^https?:\/\//i.test(input)) return input;
      return 'https://' + input.replace(/^\/*/, '');
    }

    function setBadge(text) {
      if (!badge) return;
      if (!text) { badge.classList.add('hidden'); badge.textContent = ''; }
      else { badge.textContent = text; badge.classList.remove('hidden'); }
    }

    function loadIframe(src) { frame.src = src; }

    function autoLoad(target) {
      let done = false;
      frame.addEventListener('load', () => { if (done) return; done = true; setBadge(''); }, { once: true });
      frame.src = target;
      setTimeout(() => {
        if (done) return;
        if (PROXY_ORIGIN) {
          setBadge(`Target refused iframe. Switching to proxy for ${target}`);
          frame.src = `${PROXY_ORIGIN}/?url=${encodeURIComponent(target)}`;
        } else {
          setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.');
        }
      }, LOAD_TIMEOUT_MS);
    }

    /* ---------- URL parsing: hash + query for backward compat ---------- */
    function parseHashParams(hash) {
      // format: #/vertical/host?key=val&color=%23xx;%23yy
      const m = hash.match(/^#\/(.*?)\/(.*)$/);
      let routeRest = m ? m[2] : '';
      let query = '';
      const qm = routeRest.indexOf('?');
      if (qm !== -1) { query = routeRest.slice(qm + 1); routeRest = routeRest.slice(0, qm); }
      const params = new URLSearchParams(query);
      return { routeRest, params, vertical: m ? decodeURIComponent(m[1]) : 'default' };
    }

    function parseRoute() {
      const hash = location.hash || '';
      const { routeRest, params, vertical } = parseHashParams(hash);
      state.vertical = vertical;
      state.mode     = params.get('mode') || 'auto';
      state.booking  = params.get('booking') || '';
      state.color    = params.get('color') || ''; // color from HASH

      // Also allow standard ?color=... query
      if (!state.color) {
        const qs = new URLSearchParams(location.search);
        state.color = qs.get('color') || '';
      }
      state.targetUrl = normaliseTarget(routeRest);
    }

    /* ---------- Color helpers ---------- */
    function isHex(x){ return /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(x); }

    function applyAccentFromParam(colorParam){
      if (!colorParam) return; // keep defaults
      const parts = colorParam.split(/[;,]/).map(s => s.trim());
      const bg = parts[0] || '';
      const fg = parts[1] || '';
      if (isHex(bg)) document.documentElement.style.setProperty('--accent-bg', bg);
      if (isHex(fg)) document.documentElement.style.setProperty('--accent-fg', fg);
    }

    /* ---------- Google Sheet (gviz) fetch & parse ---------- */
    async function fetchSheetConfig(){
      if (!SHEET_GVIZ_URL || SHEET_GVIZ_URL.includes("PASTE_YOUR")) return [];
      const res = await fetch(SHEET_GVIZ_URL, { cache:'no-store' });
      const txt = await res.text();
      // Strip JSONP wrapper
      const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1));
      const cols = (json.table.cols || []).map(c => (c.label || c.id || '').toString().trim().toLowerCase());
      const rows = json.table.rows || [];
      const out  = [];
      rows.forEach(r => {
        const obj = {};
        (r.c || []).forEach((cell, i) => {
          const key = cols[i] || ('col' + i);
          const v   = cell && (cell.v != null ? cell.v : cell.f);
          if (v != null) obj[key] = String(v).trim();
        });
        if (Object.keys(obj).length) out.push(obj);
      });
      return out;
    }

    async function loadConfigForHost(host){
      try{
        const rows = await fetchSheetConfig();
        if (!rows.length) return null;
        // normalize + match on host
        const norm = (h) => (h||'').toLowerCase().replace(/^https?:\/\//,'').replace(/^www\./,'').replace(/\/+$/,'');
        const row  = rows.find(r => norm(r.host) === norm(host));
        if (!row) return null;

        const colorCombined = row.color || (
          (row.color_bg && row.color_fg) ? `${row.color_bg};${row.color_fg}` : ''
        );

        return {
          host      : row.host || host,
          targetUrl : row.targeturl || row.targetUrl || '',
          mode      : (row.mode || '').toLowerCase() || 'auto',
          booking   : row.booking || '',
          color     : colorCombined
        };
      }catch(e){
        console.error('Sheet config error', e);
        return null;
      }
    }

    /* ---------- Apply current state to UI ---------- */
    function applyState() {
      // 1) parse URL-based route (legacy hash/query)
      parseRoute();

      // 2) merge sheet overrides (but let explicit URL color win)
      const hasUrlColor = !!state.color;
      if (overrides){
        if (overrides.targetUrl) state.targetUrl = normaliseTarget(overrides.targetUrl || overrides.host);
        if (overrides.mode)      state.mode      = overrides.mode || state.mode;
        if (overrides.booking)   state.booking   = overrides.booking || state.booking;
        if (overrides.color && !hasUrlColor) state.color = overrides.color; // URL color has precedence
        // If no targetUrl in row, default to https://<host>
        if (!overrides.targetUrl && overrides.host) {
          state.targetUrl = normaliseTarget(overrides.host);
        }
      }

      // 3) apply theme colors from (URL or sheet)
      applyAccentFromParam(state.color);

      // 4) guard target
      if (!state.targetUrl) {
        setBadge('Add a #/vertical/host route or use /dental-chat/<host>');
        chat.style.display = 'none';
        launcher.style.display = 'none';
        return;
      }

      // 5) show chat & booking
      chat.style.display = 'block';
      launcher.style.display = 'none';
      if (state.booking) { cta.href = state.booking; ctaWrap.style.display = 'block'; }
      else { ctaWrap.style.display = 'none'; }

      // 6) load site
      if (state.mode === 'proxy') {
        if (!PROXY_ORIGIN) { setBadge('Proxy mode requires PROXY_ORIGIN'); loadIframe(state.targetUrl); }
        else { setBadge(`Viewing proxied copy of ${state.targetUrl}`); loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`); }
      } else if (state.mode === 'iframe') {
        setBadge(''); loadIframe(state.targetUrl);
      } else {
        setBadge('Loading target in iframe'); autoLoad(state.targetUrl);
      }
    }

    /* ---------- Boot ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      // Minimise / restore
      const minBtn = $('min');
      if (minBtn) {
        minBtn.addEventListener('click', (e) => {
          e.preventDefault();
          chat.style.display = 'none';
          launcher.style.display = 'inline-flex';
        });
      }
      launcher.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'block';
        launcher.style.display = 'none';
      });

      // Path-based mapping: /dental-chat/<host>
      const slugHost = getHostFromPath();
      if (slugHost) {
        setBadge('Loading site config…');
        const cfg = await loadConfigForHost(slugHost);
        overrides = cfg || null;
        setBadge('');
      } else if (!location.hash) {
        // Legacy default if neither path nor hash is present
        location.hash = '#/dental/themoderndentist.co.uk?mode=auto';
      }

      applyState();
    });

    // Re-apply on hash change (legacy routing still supported)
    window.addEventListener('hashchange', applyState);

    // Visual viewport → CSS var for responsive height
    (function(){
      const setVh = () => {
        const h = (window.visualViewport?.height || window.innerHeight);
        document.documentElement.style.setProperty('--vh-px', `${h}px`);
      };
      setVh();
      window.addEventListener('resize', setVh);
      window.visualViewport && window.visualViewport.addEventListener('resize', setVh);
    })();
  </script>

  <!-- N8N Chat Client -->
  <script>
    const pageUrl   = window.location.href;
    const webhook   = 'https://jemima-ai.app.n8n.cloud/webhook/e1b970c6-a889-406c-b0f3-9479bae639e1/chat';
    const sessionId = (crypto.randomUUID && crypto.randomUUID()) || Date.now().toString(36);

    const box   = document.getElementById('chat-body');
    const input = document.getElementById('chat-input');
    const form  = document.getElementById('form');

    function add (text, role = 'ai') {
      const div     = document.createElement('div');
      div.className = role === 'user' ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble';
      div.innerHTML = `<p>${text}</p>`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
      box.classList.add('show');
    }

    function parse (raw, hdr) {
      if ((hdr.get('content-type') || '').includes('application/json')) {
        try {
          let d = JSON.parse(raw);
          if (Array.isArray(d)) d = d[0] || {};
          return (
            d.reply   || d.output  || d.text || d.message ||
            d.answer  || d.content ||
            (d.choices && d.choices[0]?.message.content) ||
            raw
          );
        } catch {}
      }
      return raw;
    }

    async function sendMessage () {
      const msg = input.value.trim();
      if (!msg) return;

      add(msg, 'user');
      input.value = '';

      try {
        const res = await fetch(webhook, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify({
            sessionId,
            route     : 'general',
            action    : 'sendMessage',
            chatInput : msg,
            pageUrl
          })
        });
        const raw = await res.text();
        add(parse(raw, res.headers), 'ai');
      } catch (err) {
        console.error(err);
        add('Could not reach the server.', 'ai');
      }
    }

    /* Submit on Return (Enter) */
    form.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        form.requestSubmit ? form.requestSubmit() : form.dispatchEvent(new Event('submit', {cancelable:true}));
      }
    });

    /* Focus desktop users on load */
    window.addEventListener('load', () => {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (!isMobile) input.focus({ preventScroll: true });
    });

    /* Optional quick-links */
    const qlinks = document.getElementById('chat-quick-links');
    if (qlinks) {
      qlinks.addEventListener('click', e => {
        if(e.target.classList.contains('qlink')){
          e.preventDefault();
          input.value = e.target.dataset.msg || '';
          sendMessage();
        }
      });
    }
  </script>

  <!-- Booking script placeholder (kept, no conflicts) -->
  <script>
    const BOOKING_URL = 'https://jemima-ai.app.n8n.cloud/webhook/dental-demo-booking-form';
    const TIME_ZONE   = 'Europe/London';
    document.addEventListener('DOMContentLoaded',()=>{
      const form = document.getElementById('appointment-form');
      if (!form) return;
      /* booking logic lives here when present */
    });
  </script>

</body>
</html>

