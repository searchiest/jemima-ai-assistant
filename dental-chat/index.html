<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI — Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#0b0b0c; }

    /* Frame fills viewport */
    .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background:#111; }

    /* Overlay UI */
    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem; background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px; font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    /* Chat window */
    .chat {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      width: 380px;
      max-width: calc(100vw - 1rem);
      z-index: 50;
      color: #0b0b0c;
    }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem;
      overflow: hidden;
    }
    .bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
      padding: .6rem .8rem;
      background: transparent;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }
    .header-image { display:flex; align-items:center; gap:.75rem; }
    .header-image img {
      width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display:block;
      outline: 2px solid #fff; /* nice ring like Tailwind's ring-white */
      outline-offset: 0;
    }
    .header-image .title { font-size: 14px; font-weight: 600; }

    .body { height: 420px; max-height: 60vh; overflow-y: auto; padding: .75rem; font-size: 14px; background: transparent; }
    .row { display:flex; margin:.45rem 0; }
    .row.me { justify-content:flex-end; }
    .bubble { max-width:85%; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; }
    .me .bubble { background:#2563eb; color:#fff; }

    .composer {
      display:flex; gap:.5rem; padding:.5rem; border-top:1px solid #ececec;
      background: rgba(255,255,255,0.80);
    }
    .composer input {
      flex:1; border:1px solid #d1d5db; border-radius:.7rem; padding:.58rem .75rem; font-size:14px; background:#fff;
    }
    .composer button {
      border:0; background:#2563eb; color:#fff; border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer;
    }

    .cta-wrap {
      padding:.5rem; border-top:1px solid rgba(0,0,0,.06); background:transparent; text-align:left;
    }
    .cta-wrap a {
      display:inline-block; background:#2563eb; color:#fff; text-decoration:none; border-radius:.7rem;
      padding:.6rem .9rem; font-weight:600; font-size:14px; box-shadow:0 6px 18px rgba(37,99,235,.35);
    }
    .cta-wrap a:hover { filter:brightness(0.95); }

    @media (max-width:640px) {
      .chat { left:0; right:0; bottom:0; width:100vw; }
      .chat-card { border-radius:1rem 1rem 0 0; }
    }

    /* Closed (launcher) button — pill with avatar + "Chat" */
    .launcher {
      position: fixed; right: 1rem; bottom: 1rem; z-index: 80;
      border: 0; border-radius: 9999px; padding: .375rem .625rem .375rem .375rem;
      background: #2563eb; color: #fff; display: none; /* shown when chat hidden */
      align-items: center; gap: .5rem; cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .launcher img {
      width: 28px; height: 28px; border-radius: 50%; object-fit: cover; display:block;
      outline: 2px solid #fff; outline-offset: 0;
    }
    .launcher span {
      font-size: 14px; font-weight: 600; line-height: 1; padding-right: .25rem;
    }

    /* Top controls (optional; hide if you don't want them) */
    .controls {
      position: fixed; left: 1rem; top: 1rem; z-index: 70; display:flex; gap:.5rem; align-items:center;
      background: rgba(255,255,255,.08); color:#fff; padding:.5rem; border-radius:.75rem;
      backdrop-filter: blur(8px) saturate(140%); border:1px solid rgba(255,255,255,.18); flex-wrap: wrap;
    }
    .controls input, .controls select { background: rgba(255,255,255,.85); color:#0b0b0c; border:1px solid #d1d5db; border-radius:.5rem; padding:.4rem .5rem; font-size: 12px; }
    .controls button { background:#fff; color:#0b0b0c; border:1px solid #d1d5db; border-radius:.5rem; padding:.4rem .6rem; font-size:12px; }
    @media (max-width: 640px) {
      .controls { left: 50%; transform: translateX(-50%); top: .75rem; width: calc(100vw - 1.5rem); gap: .4rem; padding: .45rem; }
      .controls input, .controls select, .controls button { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Status badge and link generator -->
  <div id="badge" class="badge hidden"></div>
  <div class="controls" id="controls">
    <label style="font-size:12px">Vertical
      <select id="vertical">
        <option value="dental">dental</option>
        <option value="default">default</option>
      </select>
    </label>
    <input id="host" placeholder="example.com or https://example.com/path" size="28" />
    <input id="booking" placeholder="Booking URL (optional)" size="28" />
    <select id="mode">
      <option value="auto">auto</option>
      <option value="iframe">iframe</option>
      <option value="proxy">proxy</option>
    </select>
    <button id="go">Open</button>
    <button id="copy">Copy link</button>
  </div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat.png" alt="Jemima">
          <div class="title">Jemima Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer">Minimise</button>
      </div>

      <div class="body" id="log">
        <div class="row"><div class="bubble">Hi, I am Jemima. Ask me about this page.</div></div>
      </div>

      <form class="composer" id="form">
        <input id="q" placeholder="Ask Jemima AI about this page" autocomplete="off" />
        <button type="submit">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Closed state (pill button with avatar + text) -->
  <button id="launcher" class="launcher" aria-label="Open chat" title="Open chat">
    <img src="https://jemima.ai/jemima-chat.png" alt="Jemima" />
    <span>Chat</span>
  </button>

  <script>
    /** Jemima GH Pages Test — routing + iframe + overlay chat with booking CTA */
    const PROXY_ORIGIN = "";  // Set if you deploy a proxy worker
    const LOAD_TIMEOUT_MS = 5000;

    const $ = id => document.getElementById(id);
    const frame = $('frame');
    const badge = $('badge');
    const chat = $('chat');
    const launcher = $('launcher');
    const log = $('log');
    const ctaWrap = $('ctaWrap');
    const cta = $('cta');

    const state = { vertical: 'default', targetUrl: '', mode: 'auto', booking: '' };

    function normaliseTarget(input) {
      if (!input) return '';
      if (/^https?:\/\//i.test(input)) return input;
      return 'https://' + input.replace(/^\/*/, '');
    }

    function parseRoute() {
      const hash = location.hash || '';
      const m = hash.match(/^#\/(.*?)\/(.*)$/);
      state.vertical = m ? decodeURIComponent(m[1]) : 'default';
      let rest = m ? m[2] : '';
      let query = '';
      const qm = rest.indexOf('?');
      if (qm !== -1) { query = rest.slice(qm + 1); rest = rest.slice(0, qm); }
      const params = new URLSearchParams(query);
      state.mode = params.get('mode') || 'auto';
      state.booking = params.get('booking') || '';
      state.targetUrl = normaliseTarget(rest);
    }

    function setBadge(text) {
      if (!text) { badge.classList.add('hidden'); badge.textContent = ''; }
      else { badge.textContent = text; badge.classList.remove('hidden'); }
    }

    function shareLink(v, target, mode, booking) {
      const base = location.href.split('#')[0];
      const core = `${base}#/` + encodeURIComponent(v) + '/' + encodeURIComponent(target.replace(/^https?:\/\//i, ''));
      const params = new URLSearchParams();
      if (mode) params.set('mode', mode);
      if (booking) params.set('booking', booking);
      const qs = params.toString();
      return qs ? `${core}?${qs}` : core;
    }

    async function openFromControls() {
      const v = $('vertical').value;
      const raw = $('host').value.trim();
      const m = $('mode').value;
      const booking = $('booking').value.trim();
      const target = normaliseTarget(raw);
      const url = shareLink(v, target, m, booking);
      location.replace(url);
    }

    function loadIframe(src) { frame.src = src; }

    function autoLoad(target) {
      let done = false;
      frame.addEventListener('load', () => { if (done) return; done = true; setBadge(''); }, { once: true });
      frame.src = target;
      setTimeout(() => {
        if (done) return;
        if (PROXY_ORIGIN) { setBadge(`Target refused iframe. Switching to proxy for ${target}`); frame.src = `${PROXY_ORIGIN}/?url=${encodeURIComponent(target)}`; }
        else { setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.'); }
      }, LOAD_TIMEOUT_MS);
    }

    function applyState() {
      parseRoute();
      if (!state.targetUrl) {
        setBadge('Set a target URL to start');
        chat.style.display = 'none';
        launcher.style.display = 'none';
        return;
      }
      $('vertical').value = state.vertical;
      $('host').value = state.targetUrl;
      $('mode').value = state.mode;
      $('booking').value = state.booking;

      chat.style.display = 'block';
      launcher.style.display = 'none';

      if (state.booking) { cta.href = state.booking; ctaWrap.style.display = 'block'; }
      else { ctaWrap.style.display = 'none'; }

      if (state.mode === 'proxy') {
        if (!PROXY_ORIGIN) { setBadge('Proxy mode requires PROXY_ORIGIN'); loadIframe(state.targetUrl); }
        else { setBadge(`Viewing proxied copy of ${state.targetUrl}`); loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`); }
      } else if (state.mode === 'iframe') {
        setBadge(''); loadIframe(state.targetUrl);
      } else {
        setBadge('Loading target in iframe'); autoLoad(state.targetUrl);
      }
    }

    // Controls bar actions
    document.addEventListener('DOMContentLoaded', () => {
      $('go').addEventListener('click', openFromControls);
      $('copy').addEventListener('click', async () => {
        const v = $('vertical').value; const raw = $('host').value.trim();
        const m = $('mode').value; const booking = $('booking').value.trim();
        if (!raw) return;
        const u = shareLink(v, normaliseTarget(raw), m === 'auto' ? '' : m, booking);
        await navigator.clipboard.writeText(u); setBadge('Link copied'); setTimeout(() => setBadge(''), 1500);
      });

      // Reliable minimise / restore
      const minBtn = $('min');
      minBtn.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'none';
        launcher.style.display = 'inline-flex';  // show pill with avatar + "Chat"
      });

      launcher.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'block';
        launcher.style.display = 'none';
      });
    });

    window.addEventListener('hashchange', applyState);

    if (!location.hash) {
      location.hash = '#/dental/themoderndentist.co.uk?mode=auto';
    }
    applyState();
  </script>
</body>
</html>
