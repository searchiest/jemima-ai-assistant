<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI — Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#0b0b0c; }

    /* Frame fills viewport */
    .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background:#111; }

    /* Overlay UI */
    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem; background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px; font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    /* Chat window */
    .chat { position: fixed; right: 1rem; bottom: 1rem; width: 380px; max-width: calc(100vw - 1rem); z-index: 50; color: #0b0b0c; }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem;
      overflow: hidden;
    }
    .bar {
      display: flex; align-items: center; justify-content: space-between; gap: .5rem;
      padding: .6rem .8rem; background: transparent; border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }
    .header-image { display:flex; align-items:center; gap:.75rem; }
    .header-image img {
      width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display:block;
      outline: 0px solid #fff; outline-offset: 0;
    }
    .header-image .title { font-size: 12px; font-weight: 600; }

    .body { height: 420px; max-height: 60vh; overflow-y: auto; padding: .75rem; font-size: 14px; background: transparent; }
    .row { display:flex; margin:.45rem 0; }
    .row.me { justify-content:flex-end; }
    .bubble { max-width:85%; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; }
    .me .bubble { background:#2563eb; color:#fff; }

    .composer {
      display:flex; gap:.5rem; align-items:center; padding:.5rem; border-top:1px solid #ececec;
      background: rgba(255,255,255,0.80);
    }
    .composer input {
      flex:1; border:1px solid #d1d5db; border-radius:.7rem; padding:.58rem .75rem; font-size:14px; background:#fff;
    }
    .composer button {
      border:0; background:#2563eb; color:#fff; border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer;
    }

    /* WhatsApp button (inside composer) */
    .wa-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:999px; border:0; cursor:pointer;
      background:#22c55e; box-shadow:0 6px 16px rgba(0,0,0,.18);
    }
    .wa-btn svg{ width:22px; height:22px; fill:#fff; display:block; }

    .cta-wrap { padding:.5rem; border-top:1px solid rgba(0,0,0,.06); background:transparent; text-align:left; }
    .cta-wrap a {
      display:inline-block; background:#2563eb; color:#fff; text-decoration:none; border-radius:.7rem;
      padding:.6rem .9rem; font-weight:600; font-size:14px; box-shadow:0 6px 18px rgba(37,99,235,.35);
    }
    .cta-wrap a:hover { filter:brightness(0.95); }

    @media (max-width:640px) {
      .chat { left:0; right:0; bottom:0; width:100vw; }
      .chat-card { border-radius:1rem 1rem 0 0; }
    }

    /* Closed (launcher) button — pill with avatar + "Chat" + WhatsApp badge */
    .launcher {
      position: fixed; right: 1rem; bottom: 1rem; z-index: 80;
      border: 0; border-radius: 9999px; padding: .375rem .9rem .375rem .375rem;
      background: #2563eb; color: #fff; display: none; /* shown when chat hidden */
      align-items: center; gap: .5rem; cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .launcher img {
      width: 28px; height: 28px; border-radius: 50%; object-fit: cover; display:block;
      outline: 2px solid #fff; outline-offset: 0;
    }
    .launcher span { font-size: 14px; font-weight: 600; line-height: 1; padding-right: .25rem; }
    .launcher .wa-badge {
      margin-left:.35rem; display:none; align-items:center; justify-content:center;
      width:24px; height:24px; border-radius:999px; background:#22c55e;
    }
    .launcher .wa-badge svg{ width:14px; height:14px; fill:#fff; }

    /* Top controls (optional; hide if you don't want them) */
    .controls {
      position: fixed; left: 1rem; top: 1rem; z-index: 70; display:flex; gap:.5rem; align-items:center;
      background: rgba(255,255,255,.08); color:#fff; padding:.5rem; border-radius:.75rem;
      backdrop-filter: blur(8px) saturate(140%); border:1px solid rgba(255,255,255,.18); flex-wrap: wrap;
    }
    .controls input, .controls select { background: rgba(255,255,255,.85); color:#0b0b0c; border:1px solid #d1d5db; border-radius:.5rem; padding:.4rem .5rem; font-size: 12px; }
    .controls button { background:#fff; color:#0b0b0c; border:1px solid #d1d5db; border-radius:.5rem; padding:.4rem .6rem; font-size:12px; }
    @media (max-width: 640px) {
      .controls { left: 50%; transform: translateX(-50%); top: .75rem; width: calc(100vw - 1.5rem); gap: .4rem; padding: .45rem; }
      .controls input, .controls select, .controls button { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Status badge and link generator -->
  <div id="badge" class="badge hidden"></div>
  <div class="controls" id="controls">
    <label style="font-size:12px">Vertical
      <select id="vertical">
        <option value="dental">dental</option>
        <option value="default">default</option>
      </select>
    </label>
    <input id="host" placeholder="example.com or https://example.com/path" size="28" />
    <input id="booking" placeholder="Booking URL (optional)" size="28" />
    <input id="wa" placeholder="WhatsApp (link or +number)" size="26" />
    <input id="wamessage" placeholder="Prefill message (optional)" size="24" />
    <select id="mode">
      <option value="auto">auto</option>
      <option value="iframe">iframe</option>
      <option value="proxy">proxy</option>
    </select>
    <button id="go">Open</button>
    <button id="copy">Copy link</button>
  </div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat.png" alt="Jemima">
          <div class="title">Jemima </br>Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer">Minimise</button>
      </div>

      <div class="body" id="log">
        <div class="row"><div class="bubble">Hi, I'm Jemima. I can answer thousands of dental and service questions.</div></div>
      </div>

      <form class="composer" id="form" onsubmit="return false;">
        <input id="q" placeholder="Ask Jemima!" autocomplete="off" />
        <!-- WhatsApp icon (shown only if configured) -->
        <a id="waLink" class="wa-btn" href="#" target="_blank" rel="noopener" style="display:none" aria-label="Chat on WhatsApp" title="Chat on WhatsApp">
          <svg viewBox="0 0 32 32" aria-hidden="true"><path d="M19.11 17.09c-.31-.15-1.82-.9-2.1-1.01-.28-.1-.49-.15-.7.16-.21.31-.81 1.01-.99 1.22-.18.21-.36.24-.67.09-.31-.15-1.29-.48-2.46-1.52-.91-.81-1.53-1.81-1.71-2.12-.18-1.075-.066-1.656.475-2.191.488-.482 1.084-1.255 1.625-1.882.543-.628.723-1.075 1.082-1.793.363-.717.182-1.344-.09-1.883-.27-.537-2.438-5.825-3.34-7.977-.902-2.15-1.803-1.792-2.436-1.792-.631 0-1.354-.09-2.076-.09s-1.896.269-2.889 1.344c-.992 1.076-3.789 3.676-3.789 8.963 0 5.288 3.879 10.397 4.422 11.113.541.716 7.49 11.92 18.5 16.223.74.32 1.31.51 1.76.65.74.24 1.41.21 1.94.13.59-.09 1.82-.74 2.08-1.45.26-.71.26-1.32.18-1.45-.07-.13-.28-.2-.59-.35zM16 3C9.93 3 5 7.93 5 14c0 2.4.79 4.62 2.14 6.42L5 27l6.78-2.11C13.5 25.62 14.72 26 16 26c6.07 0 11-4.93 11-11S22.07 3 16 3z"/></svg>
        </a>
        <button type="submit">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Closed state (pill with avatar + text + WhatsApp badge) -->
  <button id="launcher" class="launcher" aria-label="Open chat" title="Open chat">
    <img src="https://jemima.ai/jemima-chat.png" alt="Jemima" />
    <span>Chat</span>
    <span id="launcherWa" class="wa-badge" title="WhatsApp">
      <svg viewBox="0 0 32 32" aria-hidden="true"><path d="M19.11 17.09c-.31-.15-1.82-.9-2.1-1.01-.28-.1-.49-.15-.7.16-.21.31-.81 1.01-.99 1.22-.18.21-.36.24-.67.09-.31-.15-1.29-.48-2.46-1.52-.91-.81-1.53-1.81-1.71-2.12-.18-1.075-.066-1.656.475-2.191.488-.482 1.084-1.255 1.625-1.882.543-.628.723-1.075 1.082-1.793.363-.717.182-1.344-.09-1.883-.27-.537-2.438-5.825-3.34-7.977-.902-2.15-1.803-1.792-2.436-1.792-.631 0-1.354-.09-2.076-.09s-1.896.269-2.889 1.344c-.992 1.076-3.789 3.676-3.789 8.963 0 5.288 3.879 10.397 4.422 11.113.541.716 7.49 11.92 18.5 16.223.74.32 1.31.51 1.76.65.74.24 1.41.21 1.94.13.59-.09 1.82-.74 2.08-1.45.26-.71.26-1.32.18-1.45-.07-.13-.28-.2-.59-.35zM16 3C9.93 3 5 7.93 5 14c0 2.4.79 4.62 2.14 6.42L5 27l6.78-2.11C13.5 25.62 14.72 26 16 26c6.07 0 11-4.93 11-11S22.07 3 16 3z"/></svg>
    </span>
  </button>

  <script>
    /** Jemima GH Pages — overlay chat with booking + WhatsApp support */
    const PROXY_ORIGIN = "";  // Set if you deploy a proxy worker
    const LOAD_TIMEOUT_MS = 5000;

    const $ = id => document.getElementById(id);
    const frame = $('frame');
    const badge = $('badge');
    const chat = $('chat');
    const launcher = $('launcher');
    const launcherWa = $('launcherWa');
    const log = $('log');
    const ctaWrap = $('ctaWrap');
    const cta = $('cta');
    const waLink = $('waLink');

    const state = { vertical: 'default', targetUrl: '', mode: 'auto', booking: '', whatsapp: '', wamessage: '' };

    function normaliseTarget(input) {
      if (!input) return '';
      if (/^https?:\/\//i.test(input)) return input;
      return 'https://' + input.replace(/^\/*/, '');
    }

    function parseRoute() {
      const hash = location.hash || '';
      const m = hash.match(/^#\/(.*?)\/(.*)$/);
      state.vertical = m ? decodeURIComponent(m[1]) : 'default';
      let rest = m ? m[2] : '';
      let query = '';
      const qm = rest.indexOf('?');
      if (qm !== -1) { query = rest.slice(qm + 1); rest = rest.slice(0, qm); }
      const params = new URLSearchParams(query);
      state.mode = params.get('mode') || 'auto';
      state.booking = params.get('booking') || '';
      state.whatsapp = params.get('whatsapp') || '';
      state.wamessage = params.get('wamessage') || '';
      state.targetUrl = normaliseTarget(rest);
    }

    function setBadge(text) {
      if (!text) { badge.classList.add('hidden'); badge.textContent = ''; }
      else { badge.textContent = text; badge.classList.remove('hidden'); }
    }

    function buildWhatsAppHref(val, message) {
      if (!val) return '';
      if (/^https?:\/\//i.test(val)) {
        // full link; add text if provided and not present
        try { const u = new URL(val); if (message && !u.searchParams.get('text')) u.searchParams.set('text', message); return u.toString(); }
        catch { return val; }
      }
      // assume phone number; digits only
      const digits = (''+val).replace(/[^0-9]/g,'');
      const base = `https://wa.me/${digits}`;
      return message ? `${base}?text=${encodeURIComponent(message)}` : base;
    }

    function shareLink(v, target, mode, booking, whatsapp, wamessage) {
      const base = location.href.split('#')[0];
      const core = `${base}#/` + encodeURIComponent(v) + '/' + encodeURIComponent(target.replace(/^https?:\/\//i, ''));
      const params = new URLSearchParams();
      if (mode) params.set('mode', mode);
      if (booking) params.set('booking', booking);
      if (whatsapp) params.set('whatsapp', whatsapp);
      if (wamessage) params.set('wamessage', wamessage);
      const qs = params.toString();
      return qs ? `${core}?${qs}` : core;
    }

    async function openFromControls() {
      const v = $('vertical').value;
      const raw = $('host').value.trim();
      const m = $('mode').value;
      const booking = $('booking').value.trim();
      const whatsapp = $('wa').value.trim();
      const wamessage = $('wamessage').value.trim();
      const target = normaliseTarget(raw);
      const url = shareLink(v, target, m, booking, whatsapp, wamessage);
      location.replace(url);
    }

    function loadIframe(src) { frame.src = src; }

    function autoLoad(target) {
      let done = false;
      frame.addEventListener('load', () => { if (done) return; done = true; setBadge(''); }, { once: true });
      frame.src = target;
      setTimeout(() => {
        if (done) return;
        if (PROXY_ORIGIN) { setBadge(`Target refused iframe. Switching to proxy for ${target}`); frame.src = `${PROXY_ORIGIN}/?url=${encodeURIComponent(target)}`; }
        else { setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.'); }
      }, LOAD_TIMEOUT_MS);
    }

    function applyState() {
      parseRoute();

      if (!state.targetUrl) {
        setBadge('Set a target URL to start');
        chat.style.display = 'none';
        launcher.style.display = 'none';
        return;
      }

      $('vertical').value = state.vertical;
      $('host').value = state.targetUrl;
      $('mode').value = state.mode;
      $('booking').value = state.booking;
      $('wa').value = state.whatsapp;
      $('wamessage').value = state.wamessage;

      chat.style.display = 'block';
      launcher.style.display = 'none';

      // Booking CTA
      if (state.booking) { cta.href = state.booking; ctaWrap.style.display = 'block'; }
      else { ctaWrap.style.display = 'none'; }

      // WhatsApp destinations
      const defaultMsg = state.wamessage || `Hi! I'm reviewing ${state.targetUrl}`;
      const waHref = buildWhatsAppHref(state.whatsapp, defaultMsg);

      // Composer icon
      if (waHref) { waLink.href = waHref; waLink.style.display = 'inline-flex'; }
      else { waLink.style.display = 'none'; }

      // Launcher badge (opens WhatsApp directly)
      if (waHref) {
        launcherWa.style.display = 'inline-flex';
        launcherWa.dataset.href = waHref;
      } else {
        launcherWa.style.display = 'none';
        launcherWa.removeAttribute('data-href');
      }

      // Load target
      if (state.mode === 'proxy') {
        if (!PROXY_ORIGIN) { setBadge('Proxy mode requires PROXY_ORIGIN'); loadIframe(state.targetUrl); }
        else { setBadge(`Viewing proxied copy of ${state.targetUrl}`); loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`); }
      } else if (state.mode === 'iframe') {
        setBadge(''); loadIframe(state.targetUrl);
      } else {
        setBadge('Loading target in iframe'); autoLoad(state.targetUrl);
      }
    }

    // Controls bar actions & minimise/restore
    document.addEventListener('DOMContentLoaded', () => {
      $('go').addEventListener('click', openFromControls);
      $('copy').addEventListener('click', async () => {
        const v = $('vertical').value; const raw = $('host').value.trim();
        const m = $('mode').value; const booking = $('booking').value.trim();
        const whatsapp = $('wa').value.trim(); const wamessage = $('wamessage').value.trim();
        if (!raw) return;
        const u = shareLink(v, normaliseTarget(raw), m === 'auto' ? '' : m, booking, whatsapp, wamessage);
        await navigator.clipboard.writeText(u); setBadge('Link copied'); setTimeout(() => setBadge(''), 1500);
      });

      // Minimise / restore
      const minBtn = $('min');
      minBtn.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'none';
        launcher.style.display = 'inline-flex';
      });

      // Clicking pill: open chat; clicking green badge only: open WhatsApp
      launcher.addEventListener('click', (e) => {
        const inBadge = e.target.closest('.wa-badge');
        if (inBadge && launcherWa.dataset.href) {
          window.open(launcherWa.dataset.href, '_blank', 'noopener');
          return;
        }
        chat.style.display = 'block';
        launcher.style.display = 'none';
      });

      launcherWa.addEventListener('click', (e) => {
        e.stopPropagation();
        if (launcherWa.dataset.href) window.open(launcherWa.dataset.href, '_blank', 'noopener');
      });
    });

    window.addEventListener('hashchange', applyState);

    if (!location.hash) {
      location.hash = '#/dental/themoderndentist.co.uk?mode=auto';
    }
    applyState();
  </script>
</body>
</html>
