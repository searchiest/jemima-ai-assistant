<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI â€” Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#f5f7fb; }

    /* ---------- Theme variables (can be overridden by URL) ---------- */
    :root{
      /* Chat sizing */
      --chat-w: clamp(320px, 28vw, 420px);
      --chat-h: min(72vh, calc(var(--vh-px) - 96px));
      --pad-right: max(1rem, env(safe-area-inset-right));
      --pad-bottom: max(1rem, env(safe-area-inset-bottom));
      --vh-px: 100vh;

      /* Accent colors (default): bubbles + buttons */
      --accent-bg: #2563eb;
      --accent-fg: #ffffff;

      /* Shared avatar sizes */
      --avatar: 46px;
      --avatar-img: 46px;
    }

    /* Framed site fills viewport */
    .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background: transparent; }

    /* Status badge */
    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem;
      background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px;
      font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    /* Chat container */
    .chat {
      position: fixed;
      right: calc(var(--pad-right) + 3px);  /* Added 3px margin */
      bottom: var(--pad-bottom);
      width: var(--chat-w);
      z-index: 50;
      color: #0b0b0c;
    }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem;
      overflow: hidden;
      display:flex;
      flex-direction:column;
      max-height: var(--chat-h);
    }

    .bar { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid rgba(0,0,0,.06); }

    /* Chat header */
    .header-image{
      position: relative !important;
      display: inline-block !important;
      width: var(--avatar) !important;
      height: var(--avatar) !important;
      flex: 0 0 var(--avatar);
    }
    .header-image::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:50%;
      background: var(--accent-bg);
      z-index:0;
    }
    .header-image img{
      position:absolute !important;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%);
      width: var(--avatar-img) !important;
      height: var(--avatar-img) !important;
      border-radius:50%;
      object-fit: cover;
      z-index:1;
      box-shadow: 0 0 0 2px rgba(255,255,255,.85);
    }
    .header-title{
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:left;
      line-height:1.1;
      font-weight:400;
      font-size:14px;
      margin-top:0 !important;
    }
    #min{ margin-left: auto; }

    /* Messages */
    .body { flex:1; min-height:0; overflow:auto; padding:.75rem; font-size:14px; background: transparent; }
    .chat-bubble { max-width:85%; margin:.45rem 0; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; line-height:1.35; }
    .chat-bubble p { margin:0; }
    .ai-bubble { background:#f2f2f3; color:#0b0b0c; align-self:flex-start; }
    .user-bubble { background: var(--accent-bg); color: var(--accent-fg); align-self:flex-end; }
    #chat-body { display:flex; flex-direction:column; }

    /* Composer */
    .composer {
      display:flex; align-items:center; gap:.5rem;
      padding:.5rem; border-top:1px solid #ececec; background: rgba(255,255,255,0.80);
    }
    .composer input{
      flex:1; border:1px solid #d1d5db; border-radius:.7rem;
      padding:.58rem .75rem; font-size:14px; background:#fff; height:40px;
    }
    .composer button{
      border:0; background: var(--accent-bg); color: var(--accent-fg);
      border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer;
    }

    .cta-wrap a{
      display:inline-block; text-decoration:none;
      background: var(--accent-bg); color: var(--accent-fg);
      border-radius:.7rem; padding:.6rem .9rem;
      margin:5px; font-weight:600; font-size:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }

    /* Launcher (minimised) */
    .launcher {
      position: fixed;
      right: calc(1rem + 3px); /* same 3px margin */
      bottom: 1rem;
      z-index: 80;
      border: 0;
      background: var(--accent-bg);
      color: var(--accent-fg);
      border-radius: 999px;
      padding: .55rem .8rem;
      display: none;
      align-items: center;
      gap:.5rem;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* Launcher icon matches chat avatar */
    .launcher-icon {
      position: relative;
      width: var(--avatar) !important;
      height: var(--avatar) !important;
      border-radius:50%;
      flex-shrink:0;
      display:block;
      background: var(--accent-bg);
      box-shadow: 0 0 0 2px rgba(255,255,255,.85);
    }
    .launcher-icon::before {
      content:"";
      position:absolute;
      inset:0;
      border-radius:50%;
      background: var(--accent-bg);
      z-index:0;
    }
    .launcher-icon img,
    .launcher-icon[src] {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width: var(--avatar-img);
      height: var(--avatar-img);
      border-radius:50%;
      object-fit:cover;
      z-index:1;
    }

    .launcher span { font-size: 14px; font-weight: 700; }

    @media (max-width:480px){
      :root{ --chat-w:100vw; --chat-h:calc(var(--vh-px) - 72px); }
      .chat{ left:0; right:0; bottom:0; }
      .chat-card{ border-radius:1rem 1rem 0 0; }
    }
  </style>
</head>
<body>
  <!-- Status badge -->
  <div id="badge" class="badge hidden"></div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat-transparent.png" alt="Jemima">
        </div>
        <div class="header-title">
          <div class="title">Jemima <br/>Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer" aria-label="Minimise chat"><b>X</b></button>
      </div>

      <div class="body" id="chat-body" aria-live="polite">
        <div class="chat-bubble ai-bubble"><p>Hi, I'm Jemima. I can answer thousands of Dental and Service questions.</p></div>
      </div>

      <div id="chat-quick-links" style="display:flex; gap:.5rem; padding:0 .75rem .75rem;"></div>

      <form class="composer" id="form">
        <label for="chat-input" class="visually-hidden" style="position:absolute;left:-9999px;">Message</label>
        <input id="chat-input" type="text" placeholder="Ask Jemima About Anything Dental" autocomplete="off" autocapitalize="sentences" spellcheck="true" />
        <button type="submit" id="sendBtn" aria-label="Send">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Launcher -->
  <button id="launcher" class="launcher" aria-label="Open chat">
    <div class="launcher-icon">
      <img src="https://jemima.ai/jemima-chat-transparent.png" alt="Jemima" />
    </div>
    <span>Chat</span>
  </button>

  <!-- scripts unchanged -->
  <script>
    const PROXY_ORIGIN = "";
    const LOAD_TIMEOUT_MS = 5000;
    const $ = id => document.getElementById(id);
    const frame = $('frame'), badge = $('badge'), chat = $('chat'), launcher = $('launcher');
    const ctaWrap = $('ctaWrap'), cta = $('cta');
    const state = { vertical:'default', targetUrl:'', mode:'auto', booking:'', color:'' };

    function normaliseTarget(i){if(!i)return'';if(/^https?:\/\//i.test(i))return i;return'https://'+i.replace(/^\/*/,'');}
    function parseHashParams(h){const m=h.match(/^#\/(.*?)\/(.*)$/);let r=m?m[2]:'';let q='';const qm=r.indexOf('?');if(qm!==-1){q=r.slice(qm+1);r=r.slice(0,qm);}const p=new URLSearchParams(q);return{routeRest:r,params:p,vertical:m?decodeURIComponent(m[1]):'default'};}
    function parseRoute(){const h=location.hash||'';const{routeRest,params,vertical}=parseHashParams(h);state.vertical=vertical;state.mode=params.get('mode')||'auto';state.booking=params.get('booking')||'';state.color=params.get('color')||'';state.targetUrl=normaliseTarget(routeRest);if(!state.color){const qs=new URLSearchParams(location.search);state.color=qs.get('color')||'';}}
    function setBadge(t){if(!badge)return;if(!t){badge.classList.add('hidden');badge.textContent='';}else{badge.textContent=t;badge.classList.remove('hidden');}}
    function loadIframe(s){frame.src=s;}
    function autoLoad(t){let d=false;frame.addEventListener('load',()=>{if(d)return;d=true;setBadge('');},{once:true});frame.src=t;setTimeout(()=>{if(d)return;if(PROXY_ORIGIN){setBadge(`Target refused iframe. Switching to proxy for ${t}`);frame.src=`${PROXY_ORIGIN}/?url=${encodeURIComponent(t)}`;}else{setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.');}},LOAD_TIMEOUT_MS);}
    function isHex(x){return/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(x);}
    function applyAccentFromParam(c){if(!c)return;const p=c.split(/[;,]/).map(s=>s.trim());const b=p[0]||'',f=p[1]||'';if(isHex(b))document.documentElement.style.setProperty('--accent-bg',b);if(isHex(f))document.documentElement.style.setProperty('--accent-fg',f);}
    function applyState(){parseRoute();applyAccentFromParam(state.color);if(!state.targetUrl){setBadge('Add a #/vertical/host route to load a site');chat.style.display='none';launcher.style.display='none';return;}chat.style.display='block';launcher.style.display='none';if(state.booking){cta.href=state.booking;ctaWrap.style.display='block';}else{ctaWrap.style.display='none';}if(state.mode==='proxy'){if(!PROXY_ORIGIN){setBadge('Proxy mode requires PROXY_ORIGIN');loadIframe(state.targetUrl);}else{setBadge(`Viewing proxied copy of ${state.targetUrl}`);loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`);}}else if(state.mode==='iframe'){setBadge('');loadIframe(state.targetUrl);}else{setBadge('Loading target in iframe');autoLoad(state.targetUrl);}}
    document.addEventListener('DOMContentLoaded',()=>{const m=$('min');if(m){m.addEventListener('click',e=>{e.preventDefault();chat.style.display='none';launcher.style.display='inline-flex';});}launcher.addEventListener('click',e=>{e.preventDefault();chat.style.display='block';launcher.style.display='none';});});
    window.addEventListener('hashchange',applyState);
    if(!location.hash){location.hash='#/dental/themoderndentist.co.uk?mode=auto';}
    applyState();
    (function(){const setVh=()=>{const h=(window.visualViewport?.height||window.innerHeight);document.documentElement.style.setProperty('--vh-px',`${h}px`);};setVh();window.addEventListener('resize',setVh);window.visualViewport&&window.visualViewport.addEventListener('resize',setVh);})();
  </script>
</body>
</html>

