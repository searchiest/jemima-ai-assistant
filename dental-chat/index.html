<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI â€” Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    /* Light page bg so there's never a black screen */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#f5f7fb; }

    /* Frame fills viewport */
    .frame {
      position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh;
      background: transparent; /* was #111 (black). Make it transparent. */
    }

    /* Small status badge (safe even if unused) */
    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem;
      background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px;
      font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    /* Chat window */
    .chat { position: fixed; right: 1rem; bottom: 1rem; width: 380px; max-width: calc(100vw - 1rem); z-index: 50; color: #0b0b0c; }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem; overflow: hidden;
    }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; background:transparent; border-bottom:1px solid rgba(0,0,0,.06); }
    .header-image { display:flex; align-items:center; gap:.75rem; }
    .header-image img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .header-image .title { font-size: 12px; font-weight: 600; }

    .body { height: 420px; max-height: 60vh; overflow-y: auto; padding: .75rem; font-size: 14px; background: transparent; }
    .row { display:flex; margin:.45rem 0; }
    .row.me { justify-content:flex-end; }
    .bubble { max-width:85%; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; }
    .me .bubble { background:#2563eb; color:#fff; }

    .composer { display:flex; gap:.5rem; padding:.5rem; border-top:1px solid #ececec; background: rgba(255,255,255,0.80); }
    .composer input { flex:1; border:1px solid #d1d5db; border-radius:.7rem; padding:.58rem .75rem; font-size:14px; background:#fff; }
    .composer button { border:0; background:#2563eb; color:#fff; border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer; }

    .cta-wrap { padding:.5rem; border-top:1px solid rgba(0,0,0,.06); background: transparent; text-align:left; }
    .cta-wrap a { display:inline-block; background:#2563eb; color:#fff; text-decoration:none; border-radius:.7rem; padding:.6rem .9rem; font-weight:600; font-size:14px; box-shadow: 0 6px 18px rgba(37,99,235,.35); }
    .cta-wrap a:hover { filter:brightness(0.95); }

    /* Launcher (minimised) */
    .launcher {
      position: fixed; right: 1rem; bottom: 1rem; z-index: 80; border: 0; background: #2563eb; color: #fff;
      border-radius: 999px; padding: .55rem .8rem; display: none; align-items: center; gap:.5rem; cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .launcher-icon { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    .launcher span { font-size: 14px; font-weight: 700; }

    @media (max-width:640px) {
      .chat { left:0; right:0; bottom:0; width:100vw; }
      .chat-card { border-radius:1rem 1rem 0 0; }
    }
  </style>
</head>
<body>

  <!-- Safe badge so setBadge() never errors -->
  <div id="badge" class="badge hidden"></div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat.png" alt="Jemima">
          <div class="title">Jemima <br/>Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer"><b>Minimise</b></button>
      </div>

      <div class="body" id="log">
        <div class="row"><div class="bubble">Hi, I'm Jemima. I can answer thousands of Dental and Service questions.</div></div>
      </div>

      <form class="composer" id="form" onsubmit="return false;">
        <input id="q" placeholder="Ask Jemima!" autocomplete="off" />
        <button type="submit">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Launcher -->
  <button id="launcher" class="launcher" aria-label="Open chat">
    <img src="https://jemima.ai/jemima-chat.png" alt="Jemima" class="launcher-icon" />
    <span>Chat</span>
  </button>

  <script>
    /** Jemima overlay with robust, guard-checked script */
    const PROXY_ORIGIN = "";   // set if you deploy a proxy worker
    const LOAD_TIMEOUT_MS = 5000;

    const $ = id => document.getElementById(id);
    const frame = $('frame');
    const badge = $('badge');          // may exist (we added it)
    const chat = $('chat');
    const launcher = $('launcher');
    const ctaWrap = $('ctaWrap');
    const cta = $('cta');

    const state = { vertical: 'default', targetUrl: '', mode: 'auto', booking: '' };

    function normaliseTarget(input) {
      if (!input) return '';
      if (/^https?:\/\//i.test(input)) return input;
      return 'https://' + input.replace(/^\/*/, '');
    }

    function parseRoute() {
      const hash = location.hash || '';
      const m = hash.match(/^#\/(.*?)\/(.*)$/);
      state.vertical = m ? decodeURIComponent(m[1]) : 'default';
      let rest = m ? m[2] : '';
      let query = '';
      const qm = rest.indexOf('?');
      if (qm !== -1) { query = rest.slice(qm + 1); rest = rest.slice(0, qm); }
      const params = new URLSearchParams(query);
      state.mode = params.get('mode') || 'auto';
      state.booking = params.get('booking') || '';
      state.targetUrl = normaliseTarget(rest);
    }

    function setBadge(text) {
      if (!badge) return;           // guard if removed
      if (!text) { badge.classList.add('hidden'); badge.textContent = ''; }
      else { badge.textContent = text; badge.classList.remove('hidden'); }
    }

    function loadIframe(src) { frame.src = src; }

    function autoLoad(target) {
      let done = false;
      frame.addEventListener('load', () => { if (done) return; done = true; setBadge(''); }, { once: true });
      frame.src = target;
      setTimeout(() => {
        if (done) return;
        if (PROXY_ORIGIN) {
          setBadge(`Target refused iframe. Switching to proxy for ${target}`);
          frame.src = `${PROXY_ORIGIN}/?url=${encodeURIComponent(target)}`;
        } else {
          setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.');
        }
      }, LOAD_TIMEOUT_MS);
    }

    function applyState() {
      parseRoute();

      if (!state.targetUrl) {
        // No target -> keep launcher hidden and chat hidden; show a gentle badge
        setBadge('Add a #/vertical/host route to load a site');
        chat.style.display = 'none';
        launcher.style.display = 'none';
        return;
      }

      // Show chat; hide launcher
      chat.style.display = 'block';
      launcher.style.display = 'none';

      // Booking CTA (optional)
      if (state.booking) { cta.href = state.booking; ctaWrap.style.display = 'block'; }
      else { ctaWrap.style.display = 'none'; }

      // Load site
      if (state.mode === 'proxy') {
        if (!PROXY_ORIGIN) { setBadge('Proxy mode requires PROXY_ORIGIN'); loadIframe(state.targetUrl); }
        else { setBadge(`Viewing proxied copy of ${state.targetUrl}`); loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`); }
      } else if (state.mode === 'iframe') {
        setBadge(''); loadIframe(state.targetUrl);
      } else {
        setBadge('Loading target in iframe'); autoLoad(state.targetUrl);
      }
    }

    // Minimise / restore
    document.addEventListener('DOMContentLoaded', () => {
      const minBtn = $('min');
      if (minBtn) {
        minBtn.addEventListener('click', (e) => {
          e.preventDefault();
          chat.style.display = 'none';
          launcher.style.display = 'inline-flex';
        });
      }
      launcher.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'block';
        launcher.style.display = 'none';
      });
    });

    window.addEventListener('hashchange', applyState);

    if (!location.hash) {
      // Default target if none supplied
      location.hash = '#/dental/themoderndentist.co.uk?mode=auto';
    }
    applyState();
  </script>
</body>
</html>



