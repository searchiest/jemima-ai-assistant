<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jemima AI — Site Review with Overlay Chat</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#f5f7fb; }

    .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background: transparent; }

    .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem;
      background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px;
      font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
    .hidden { display:none; }

    .chat { position: fixed; right: 1rem; bottom: 1rem; width: 380px; max-width: calc(100vw - 1rem); z-index: 50; color: #0b0b0c; }
    .chat-card {
      background: rgba(255, 255, 255, 0.60);
      backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
      border-radius: 1rem; overflow: hidden; display:flex; flex-direction:column;
      max-height: min(var(--chat-h), calc(var(--vh-px) - 96px));
    }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid rgba(0,0,0,.06); }
    .header-image { display:flex; align-items:center; gap:.75rem; }
    .header-image img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .header-image .title { font-size: 12px; font-weight: 600; }

    .body { flex:1; min-height:0; max-height: 60vh; overflow-y: auto; padding: .75rem; font-size: 14px; }

    .chat-bubble { max-width: 85%; margin:.45rem 0; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; line-height:1.35; }
    .chat-bubble p { margin:0; }
    .ai-bubble { background:#f2f2f3; color:#0b0b0c; align-self:flex-start; }
    .user-bubble { background:#2563eb; color:#fff; align-self:flex-end; }
    #chat-body { display:flex; flex-direction:column; }

    .composer { display:flex; gap:.5rem; padding:.5rem; border-top:1px solid #ececec; background: rgba(255,255,255,0.80); }
    .composer textarea { flex:1; border:1px solid #d1d5db; border-radius:.7rem; padding:.58rem .75rem; font-size:14px; background:#fff; resize:none; min-height:60px; max-height:160px; }
    .composer button { border:0; background:#2563eb; color:#fff; border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer; }

    .cta-wrap { padding:.5rem; border-top:1px solid rgba(0,0,0,.06); text-align:left; }
    .cta-wrap a { display:inline-block; background:#2563eb; color:#fff; text-decoration:none; border-radius:.7rem; padding:.6rem .9rem; font-weight:600; font-size:14px; box-shadow: 0 6px 18px rgba(37,99,235,.35); }
    .cta-wrap a:hover { filter:brightness(0.95); }

    .launcher { position: fixed; right: 1rem; bottom: 1rem; z-index: 80; border: 0; background: #2563eb; color: #fff;
      border-radius: 999px; padding: .55rem .8rem; display: none; align-items: center; gap:.5rem; cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .launcher-icon { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    .launcher span { font-size: 14px; font-weight: 700; }

    @media (max-width:640px) { .chat { left:0; right:0; bottom:0; width:100vw; } .chat-card { border-radius:1rem 1rem 0 0; } }

    :root{
      --chat-w: clamp(280px, 28vw, 380px);
      --chat-h: clamp(360px, 60vh, 560px);
      --pad-right: max(1rem, env(safe-area-inset-right));
      --pad-bottom: max(1rem, env(safe-area-inset-bottom));
      --vh-px: 100vh;
    }
    .chat{ right: var(--pad-right); bottom: var(--pad-bottom); width: var(--chat-w); }

    @media (max-width: 1024px){ :root{ --chat-w: clamp(280px, 34vw, 360px); --chat-h: clamp(340px, 56vh, 520px); } }
    @media (max-width: 768px){ :root{ --chat-w: min(92vw, 420px); --chat-h: min(58vh, 520px); } }
    @media (max-width: 480px){ :root{ --chat-w: 92vw; --chat-h: 56vh; } }
  </style>
</head>
<body>

  <div id="badge" class="badge hidden"></div>

  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site"></iframe>

  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat.png" alt="Jemima">
          <div class="title">Jemima <br/>Practice Assistant</div>
        </div>
        <button type="button" id="min" style="background:none;border:0;color:#6b7280;cursor:pointer" aria-label="Minimise chat"><b>X</b></button>
      </div>

      <div class="body" id="chat-body" aria-live="polite">
        <div class="chat-bubble ai-bubble"><p>Hi, I am Jemima. I can answer thousands of Dental and Service questions.</p></div>
      </div>

      <div id="chat-quick-links" style="display:flex; gap:.5rem; padding:0 .75rem .75rem;"></div>

      <form class="composer" id="form">
        <label for="chat-input" class="visually-hidden" style="position:absolute;left:-9999px;">Message</label>
        <textarea id="chat-input" placeholder="Ask Jemima" autocomplete="off" rows="1"></textarea>
        <button type="submit">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="#" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <button id="launcher" class="launcher" aria-label="Open chat">
    <img src="https://jemima.ai/jemima-chat.png" alt="Jemima" class="launcher-icon" />
    <span>Chat</span>
  </button>

  <script>
    /* Shell: iframe + launcher */
    const PROXY_ORIGIN = "";
    const LOAD_TIMEOUT_MS = 5000;

    const $ = id => document.getElementById(id);
    const frame = $('frame');
    const badge = $('badge');
    const chat  = $('chat');
    const launcher = $('launcher');
    const ctaWrap = $('ctaWrap');
    const cta = $('cta');

    const state = { vertical: 'default', targetUrl: '', mode: 'auto', booking: '' };

    function normaliseTarget(input) {
      if (!input) return '';
      if (/^https?:\/\//i.test(input)) return input;
      return 'https://' + input.replace(/^\/*/, '');
    }
    function parseRoute() {
      const hash = location.hash || '';
      const m = hash.match(/^#\/(.*?)\/(.*)$/);
      state.vertical = m ? decodeURIComponent(m[1]) : 'default';
      let rest = m ? m[2] : '';
      let query = '';
      const qm = rest.indexOf('?');
      if (qm !== -1) { query = rest.slice(qm + 1); rest = rest.slice(0, qm); }
      const params = new URLSearchParams(query);
      state.mode = params.get('mode') || 'auto';
      state.booking = params.get('booking') || '';
      state.targetUrl = normaliseTarget(rest);
    }
    function setBadge(text) {
      if (!badge) return;
      if (!text) { badge.classList.add('hidden'); badge.textContent = ''; }
      else { badge.textContent = text; badge.classList.remove('hidden'); }
    }
    function loadIframe(src) { frame.src = src; }
    function autoLoad(target) {
      let done = false;
      frame.addEventListener('load', () => { if (done) return; done = true; setBadge(''); }, { once: true });
      frame.src = target;
      setTimeout(() => {
        if (done) return;
        if (PROXY_ORIGIN) {
          setBadge(`Target refused iframe. Switching to proxy for ${target}`);
          frame.src = `${PROXY_ORIGIN}/?url=${encodeURIComponent(target)}`;
        } else {
          setBadge('This site likely blocks iframes. Use proxy mode or set PROXY_ORIGIN.');
        }
      }, LOAD_TIMEOUT_MS);
    }
    function applyState() {
      parseRoute();
      if (!state.targetUrl) {
        setBadge('Add a #/vertical/host route to load a site');
        chat.style.display = 'none';
        launcher.style.display = 'none';
        return;
      }
      chat.style.display = 'block';
      launcher.style.display = 'none';
      if (state.booking) { cta.href = state.booking; ctaWrap.style.display = 'block'; }
      else { ctaWrap.style.display = 'none'; }
      if (state.mode === 'proxy') {
        if (!PROXY_ORIGIN) { setBadge('Proxy mode requires PROXY_ORIGIN'); loadIframe(state.targetUrl); }
        else { setBadge(`Viewing proxied copy of ${state.targetUrl}`); loadIframe(`${PROXY_ORIGIN}/?url=${encodeURIComponent(state.targetUrl)}`); }
      } else if (state.mode === 'iframe') {
        setBadge(''); loadIframe(state.targetUrl);
      } else {
        setBadge('Loading target in iframe'); autoLoad(state.targetUrl);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      const minBtn = $('min');
      if (minBtn) {
        minBtn.addEventListener('click', (e) => {
          e.preventDefault();
          chat.style.display = 'none';
          launcher.style.display = 'inline-flex';
        });
      }
      launcher.addEventListener('click', (e) => {
        e.preventDefault();
        chat.style.display = 'block';
        launcher.style.display = 'none';
      });
    });
    window.addEventListener('hashchange', applyState);
    if (!location.hash) location.hash = '#/dental/themoderndentist.co.uk?mode=auto';
    applyState();

    (function(){
      const setVh = () => {
        const h = (window.visualViewport?.height || window.innerHeight);
        document.documentElement.style.setProperty('--vh-px', `${h}px`);
      };
      setVh();
      window.addEventListener('resize', setVh);
      window.visualViewport && window.visualViewport.addEventListener('resize', setVh);
    })();
  </script>

  <!-- N8N CHAT CLIENT -->
  <script>
    const pageUrl  = window.location.href;
    const webhook  = 'https://jemima-ai.app.n8n.cloud/webhook/e1b970c6-a889-406c-b0f3-9479bae639e1/chat';
    const sessionId = (crypto.randomUUID && crypto.randomUUID()) || Date.now().toString(36);

    const box   = document.getElementById('chat-body');
    const input = document.getElementById('chat-input');
    const form  = document.getElementById('form');

    function add (text, role = 'ai') {
      const div     = document.createElement('div');
      div.className = role === 'user' ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble';
      div.innerHTML = `<p>${text}</p>`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
      box.classList.add('show');
    }
    function parse (raw, hdr) {
      if ((hdr.get('content-type') || '').includes('application/json')) {
        try {
          let d = JSON.parse(raw);
          if (Array.isArray(d)) d = d[0] || {};
          return (
            d.reply   || d.output  || d.text || d.message ||
            d.answer  || d.content ||
            (d.choices && d.choices[0]?.message.content) ||
            raw
          );
        } catch { /* fall through */ }
      }
      return raw;
    }
    async function sendMessage () {
      const msg = input.value.trim();
      if (!msg) return;
      add(msg, 'user');
      input.value = '';
      input.style.height = '60px';
      try {
        const res = await fetch(webhook, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify({
            sessionId,
            route     : 'general',
            action    : 'sendMessage',
            chatInput : msg,
            pageUrl
          })
        });
        const raw = await res.text();
        add(parse(raw, res.headers), 'ai');
      } catch (err) {
        console.error(err);
        add('Could not reach the server.', 'ai');
      }
    }

    // Bind submit
    form.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });

    // Send on Enter, newline with Shift+Enter
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-grow textarea
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = input.scrollHeight + 'px';
    });

    // Focus on load for desktop
    window.addEventListener('load', () => {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (!isMobile) input.focus({ preventScroll: true });
    });

    // Quick links, if you add any
    const qlinks = document.getElementById('chat-quick-links');
    if (qlinks) {
      qlinks.addEventListener('click', e => {
        if(e.target.classList.contains('qlink')){
          e.preventDefault();
          input.value = e.target.dataset.msg || '';
          sendMessage();
        }
      });
    }
  </script>

  <!-- Booking script unchanged (kept) -->
  <script>
    const BOOKING_URL = 'https://jemima-ai.app.n8n.cloud/webhook/dental-demo-booking-form';
    const TIME_ZONE   = 'Europe/London';
    document.addEventListener('DOMContentLoaded',()=>{
      const form = document.getElementById('appointment-form');
      if (!form) return;
      /* … booking code unchanged … */
    });
  </script>

</body>
</html>





