<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Test Available Slots</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label { font-weight: bold; }
    select, input { margin-left: .5rem; }
  </style>
</head>
<body>
  <h1>Test Available Slots</h1>

  <p>
    <label for="day">Choose a day:</label>
    <input type="date" id="day"/>
  </p>

  <p>
    <label for="slot">Free times:</label>
    <select id="slot"></select>
  </p>

  <script>
    // ‚Üê point this at your real n8n webhook URL
    const AVAIL_URL = 'https://jemima-ai.app.n8n.cloud/webhook/availability';

    const dayInput   = document.getElementById('day');
    const slotSelect = document.getElementById('slot');

    dayInput.addEventListener('change', fetchTimes);

    async function fetchTimes() {
      const day = dayInput.value;
      console.clear();
      console.log('Requesting availability for:', day);

      // reset UI
      slotSelect.disabled = true;
      slotSelect.innerHTML = '<option>Loading‚Ä¶</option>';

      if (!day) {
        slotSelect.innerHTML = '<option>Pick a day first</option>';
        slotSelect.disabled = false;
        return;
      }

      try {
        const res = await fetch(AVAIL_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ day })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('üì• raw response:', data);

        // figure out where "busy" lives
        let busyArr = [];
        if (Array.isArray(data)) {
          busyArr = data[0]?.busy || [];
        } else {
          busyArr = data.busy 
                 || data.body?.busy 
                 || data.data?.busy 
                 || [];
        }
        console.log('üîç busyArr:', busyArr);

        // normalize to YYYY-MM-DDTHH:MM
        const busyLocal = busyArr.map(ts => ts.slice(0,16));
        console.log('‚è∞ busyLocal:', busyLocal);

        // build all half-hours from 09:00 up to 17:30
        const free = [];
        for (let h = 9; h < 18; h++) {
          for (let m of [0,30]) {
            const hh = String(h).padStart(2,'0');
            const mm = m === 0 ? '00' : '30';
            const key = `${day}T${hh}:${mm}`;
            if (!busyLocal.includes(key)) {
              free.push(key);
            }
          }
        }
        console.log('‚úÖ free slots:', free);

        // render into the dropdown
        if (free.length === 0) {
          slotSelect.innerHTML = '<option>No slots available</option>';
        } else {
          slotSelect.innerHTML = '<option value="">Select a time</option>';
          free.forEach(k => {
            const label = k.slice(11); // "HH:MM"
            slotSelect.insertAdjacentHTML(
              'beforeend',
              `<option value="${k}">${label}</option>`
            );
          });
        }
      } catch (err) {
        console.error('‚ùå fetch error:', err);
        slotSelect.innerHTML = '<option>Error loading slots</option>';
      } finally {
        slotSelect.disabled = false;
      }
    }
  </script>
</body>
</html>
