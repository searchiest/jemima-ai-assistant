<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jemima AI â€” Site Review with Overlay Chat</title>
<style>
  html, body { height: 100%; margin: 0; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#f5f7fb; }
  :root{
    --chat-w: clamp(320px, 28vw, 420px);
    --chat-h: min(72vh, calc(var(--vh-px) - 96px));
    --pad-right: max(1rem, env(safe-area-inset-right));
    --pad-bottom: max(1rem, env(safe-area-inset-bottom));
    --vh-px: 100vh;
    --accent-bg: #007bff; --accent-fg: #FFFFFF;
    --avatar: 46px; --avatar-img: 46px;
  }
  .frame { position: fixed; inset: 0; border: 0; width: 100vw; height: 100vh; background: transparent; }
  .badge { position: fixed; left: 50%; transform: translateX(-50%); top: .5rem; background: rgba(12,12,13,.85); color:#fff; padding:.35rem .7rem; border-radius:999px; font-size:12px; z-index: 60; backdrop-filter: saturate(120%) blur(6px); }
  .hidden { display:none; }
  .chat { position: fixed; right: calc(var(--pad-right) + 3px); bottom: var(--pad-bottom); width: var(--chat-w); z-index: 50; color: #0b0b0c; }
  .chat-card { background: rgba(255, 255, 255, 0.60); backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%); border: 1px solid rgba(255, 255, 255, 0.35); box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25); border-radius: 1rem; overflow: hidden; display:flex; flex-direction:column; max-height: var(--chat-h); }
  .bar { display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid rgba(0,0,0,.06); }
  .header-image{ position: relative; display: inline-block; width: var(--avatar); height: var(--avatar); flex: 0 0 var(--avatar); }
  .header-image::before{ content:""; position:absolute; inset:0; border-radius:50%; background: var(--accent-bg); z-index:0; }
  .header-image img{ position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); width: var(--avatar-img); height: var(--avatar-img); border-radius:50%; object-fit: cover; z-index:1; box-shadow: 0 0 0 2px rgba(255,255,255,.85); }
  .header-title{ display:flex; flex-direction:column; justify-content:center; text-align:left; line-height:1.1; font-weight:400; font-size:14px; margin-top:0; }
  #min{ margin-left: auto; background:none;border:0;color:#6b7280;cursor:pointer }
  .body { flex:1; min-height:0; overflow:auto; padding:.75rem; font-size:14px; background: transparent; display:flex; flex-direction:column; }
  .chat-bubble { max-width:85%; margin:.45rem 0; padding:.5rem .75rem; border-radius:1rem; background:#f2f2f3; line-height:1.35; }
  .chat-bubble p { margin:0; }
  .ai-bubble { background:#f2f2f3; color:#0b0b0c; align-self:flex-start; }
  .user-bubble { background: var(--accent-bg); color: var(--accent-fg); align-self:flex-end; }
  .composer { display:flex; align-items:center; gap:.5rem; padding:.5rem; border-top:1px solid #ececec; background: rgba(255,255,255,0.80); }
  .composer input{ flex:1; border:1px solid #d1d5db; border-radius:.7rem; padding:.58rem .75rem; font-size:14px; background:#fff; height:40px; }
  .composer button{ border:0; background: var(--accent-bg); color: var(--accent-fg); border-radius:.7rem; padding:.58rem .95rem; font-size:14px; cursor:pointer; }
  .cta-wrap a{ display:inline-block; text-decoration:none; background: var(--accent-bg); color: var(--accent-fg); border-radius:.7rem; padding:.6rem .9rem; margin:5px; font-weight:600; font-size:14px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
  .launcher { position: fixed; right: calc(1rem + 3px); bottom: 1rem; z-index: 80; border: 0; background: var(--accent-bg); color: var(--accent-fg); border-radius: 999px; padding: .55rem .8rem; display: none; align-items: center; gap:.5rem; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .launcher-icon { position: relative; width: var(--avatar); height: var(--avatar); border-radius:50%; flex-shrink:0; display:block; background: var(--accent-bg); box-shadow: 0 0 0 2px rgba(255,255,255,.85); }
  .launcher-icon::before { content:""; position:absolute; inset:0; border-radius:50%; background: var(--accent-bg); z-index:0; }
  .launcher-icon img { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width: var(--avatar-img); height: var(--avatar-img); border-radius:50%; object-fit:cover; z-index:1; }
  .launcher span { font-size: 14px; font-weight: 700; }
  @media (max-width:480px){
    :root{ --chat-w:100vw; --chat-h:calc(var(--vh-px) - 72px); }
    .chat{ left:0; right:0; bottom:0; }
    .chat-card{ border-radius:1rem 1rem 0 0; }
  }
</style>
</head>
<body>
  <!-- Status badge -->
  <div id="badge" class="badge hidden"></div>

  <!-- Target site frame -->
  <iframe id="frame" class="frame" referrerpolicy="no-referrer" loading="eager" title="Framed Site" src="https://www.solihull-dentalpractice.co.uk/"></iframe>

  <!-- Chat overlay -->
  <div id="chat" class="chat" role="dialog" aria-label="Jemima AI chat">
    <div class="chat-card">
      <div class="bar">
        <div class="header-image">
          <img src="https://jemima.ai/jemima-chat-transparent.png" alt="Jemima">
        </div>
        <div class="header-title">
          <div class="title">Jemima <br/>Practice Assistant</div>
        </div>
        <button type="button" id="min" aria-label="Minimise chat"><b>X</b></button>
      </div>

      <div class="body" id="chat-body" aria-live="polite">
        <div class="chat-bubble ai-bubble"><p>Hi, I am Jemima. I can answer thousands of Dental and Service questions.</p></div>
      </div>

      <div id="chat-quick-links" style="display:flex; gap:.5rem; padding:0 .75rem .75rem;"></div>

      <!-- IMPORTANT: no action; JS intercepts submit -->
      <form class="composer" id="form">
        <label for="chat-input" class="visually-hidden" style="position:absolute;left:-9999px;">Message</label>
        <input id="chat-input" type="text" placeholder="Ask Jemima About Anything Dental" autocomplete="off" autocapitalize="sentences" spellcheck="true" />
        <button type="submit" id="sendBtn" aria-label="Send">Send</button>
      </form>

      <div class="cta-wrap" id="ctaWrap" style="display:none">
        <a id="cta" href="https://www.solihull-dentalpractice.co.uk/contact-us/" target="_blank" rel="noopener">Book Appointment</a>
      </div>
    </div>
  </div>

  <!-- Launcher -->
  <button id="launcher" class="launcher" aria-label="Open chat">
    <div class="launcher-icon">
      <img src="https://jemima.ai/jemima-chat-transparent.png" alt="Jemima" />
    </div>
    <span>Chat</span>
  </button>

<script>
  const $ = id => document.getElementById(id);
  const chat = $('chat');
  const launcher = $('launcher');
  const ctaWrap = $('ctaWrap');
  const cta = $('cta');

  // Toggle chat open/close
  document.addEventListener('DOMContentLoaded', () => {
    const min = $('min');
    if (min) {
      min.addEventListener('click', e => {
        e.preventDefault();
        chat.style.display = 'none';
        launcher.style.display = 'inline-flex';
      });
    }
    launcher.addEventListener('click', e => {
      e.preventDefault();
      chat.style.display = 'block';
      launcher.style.display = 'none';
    });

    // Show booking CTA only if href is present
    ctaWrap.style.display = (cta && cta.getAttribute('href')) ? 'block' : 'none';
  });

  // Maintain --vh-px (fixed: use backticks)
  (function () {
    const setVh = () => {
      const h = (window.visualViewport?.height || window.innerHeight);
      document.documentElement.style.setProperty('--vh-px', `${h}px`);
    };
    setVh();
    window.addEventListener('resize', setVh);
    if (window.visualViewport) window.visualViewport.addEventListener('resize', setVh);
  })();

  // -------- Chat wiring (prevents reload) --------
  const pageUrl   = window.location.href;
  const webhook   = 'https://jemima-ai.app.n8n.cloud/webhook/8c1e652f-f59e-4489-9541-2c6d0504af75/chat';
  const sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+'-'+Math.random().toString(16).slice(2));
  const box       = $('chat-body');
  const input     = $('chat-input');
  const form      = $('form');

  const escapeHTML = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function addBubble(text, who='ai'){
    const div = document.createElement('div');
    div.className = `chat-bubble ${who==='user' ? 'user-bubble' : 'ai-bubble'}`;
    div.innerHTML = `<p>${escapeHTML(text)}</p>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  function parseReply(raw, headers){
    const ct = (headers.get('content-type') || '').toLowerCase();
    if(ct.includes('application/json')){
      try{
        let d = JSON.parse(raw);
        if(Array.isArray(d)) d = d[0] || {};
        return (
          d.reply || d.output || d.text || d.message || d.answer || d.content ||
          (d.choices && d.choices[0]?.message?.content) || raw
        );
      }catch(_){/* fall back to raw */}
    }
    return raw;
  }

  async function sendMessage(){
    const msg = input.value.trim();
    if(!msg) return;

    addBubble(msg, 'user');
    input.value = '';

    try{
      const res = await fetch(webhook, {
        method : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body   : JSON.stringify({
          sessionId,
          route     : 'general',
          action    : 'sendMessage',
          chatInput : msg,
          pageUrl
        })
      });
      const raw = await res.text();
      addBubble(parseReply(raw, res.headers), 'ai');
    }catch(err){
      console.error(err);
      addBubble('Could not reach the server.', 'ai');
    }
  }

  // Prevent page navigation on submit
  form.addEventListener('submit', (e) => {
    e.preventDefault();     // <-- stops the ? reload
    sendMessage();
  });
</script>
</body>
</html>