<!DOCTYPE html>
<html>
<head>
  <title>Twilio Call Status Test</title>
  <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .icon { font-size: 40px; cursor: pointer; }
    #status { margin-top: 20px; font-weight: bold; }
    #log { margin-top: 20px; font-family: monospace; font-size: 0.95em; background: #eee; padding: 10px; max-height: 180px; overflow-y: auto;}
    .error { color: #c00; }
  </style>
</head>
<body>

  <div>
    <span id="call-icon" class="icon">ðŸ“ž</span>
    <span id="status">Ready</span>
  </div>
  <div id="log"></div>

  <script>
  let device;
  let currentConnection;
  const logDiv = document.getElementById('log');

  function log(msg, error) {
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.innerHTML = time + ': ' + msg;
    if(error) div.classList.add('error');
    logDiv.appendChild(div);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function updateStatus(text, error) {
    const statusSpan = document.getElementById('status');
    statusSpan.textContent = text;
    statusSpan.className = error ? 'error' : '';
    log(text, error);
  }

  async function setup() {
    try {
      const res = await fetch('https://voice-tokens-2997.twil.io/token');
      const data = await res.json();
      device = new Twilio.Device(data.token, { debug: true });

      device.on('ready', () => updateStatus('Ready to call'));
      device.on('error', err => updateStatus('Error: ' + err.message, true));
      device.on('connect', conn => {
        currentConnection = conn;
        updateStatus('In progress');
      });
      device.on('disconnect', conn => {
        updateStatus('Completed');
        currentConnection = null;
      });
      device.on('cancel', conn => updateStatus('Cancelled'));
    } catch (err) {
      updateStatus('Error: ' + err.message, true);
    }
  }

  function makeCall() {
    updateStatus('Connecting');
    currentConnection = device.connect();
  }

  setup();

  document.getElementById('call-icon').onclick = () => {
    if (currentConnection) {
      currentConnection.disconnect();
      updateStatus('Completed');
    } else {
      makeCall();
    }
  };
  </script>

</body>
</html>
